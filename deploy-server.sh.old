#!/bin/bash
#
# deploy-server.sh - Deploy web server in network namespace
# Usage: ./deploy-server.sh <namespace> <port>
#

set -e

if [ $# -lt 1 ]; then
    echo "Usage: $0 <namespace> [port]"
    echo "Example: $0 myvpc-public-subnet 8080"
    exit 1
fi

NAMESPACE=$1
PORT=${2:-8080}
LOG_DIR="logs"
PID_FILE="$LOG_DIR/${NAMESPACE}_${PORT}.pid"

# Create logs directory
mkdir -p "$LOG_DIR"

# Function to log messages
log() {
    echo "[deploy-server] $1"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_DIR/deploy.log"
}

# Check if namespace exists
if ! sudo ip netns list | grep -q "^${NAMESPACE}"; then
    log "ERROR: Namespace '$NAMESPACE' does not exist"
    exit 1
fi

# Check if port is already in use in this namespace
if sudo ip netns exec "$NAMESPACE" netstat -tuln 2>/dev/null | grep -q ":${PORT} "; then
    log "WARNING: Port $PORT is already in use in namespace $NAMESPACE"
    read -p "Do you want to continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

log "Deploying web server in namespace: $NAMESPACE on port $PORT"

# Create simple index.html
HTML_CONTENT=$(cat <<EOF
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPC Test Server</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        h1 { margin-top: 0; }
        .info { 
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { color: #4ade80; }
    </style>
</head>
<body>
    <div class="container">
        <h1>í¾‰ VPC Test Server</h1>
        <p class="success">âœ“ Server is running successfully!</p>
        <div class="info">
            <strong>Namespace:</strong> $NAMESPACE<br>
            <strong>Port:</strong> $PORT<br>
            <strong>Time:</strong> $(date)<br>
        </div>
        <p>This server is running inside an isolated network namespace,
        demonstrating VPC subnet isolation.</p>
        <h2>Available Endpoints:</h2>
        <ul>
            <li><code>/</code> - This page</li>
            <li><code>/info</code> - Network information</li>
        </ul>
    </div>
</body>
</html>
EOF
)

# Create temporary directory in namespace
TEMP_DIR="/tmp/webserver_${NAMESPACE}_${PORT}"
sudo ip netns exec "$NAMESPACE" mkdir -p "$TEMP_DIR"

# Write HTML content
echo "$HTML_CONTENT" | sudo ip netns exec "$NAMESPACE" tee "$TEMP_DIR/index.html" > /dev/null

# Create info page with network details
sudo ip netns exec "$NAMESPACE" bash -c "cat > $TEMP_DIR/info.html" <<EOF
<!DOCTYPE html>
<html>
<head><title>Network Info</title></head>
<body>
<h1>Network Information</h1>
<h2>IP Addresses:</h2>
<pre>$(sudo ip netns exec "$NAMESPACE" ip addr show)</pre>
<h2>Routing Table:</h2>
<pre>$(sudo ip netns exec "$NAMESPACE" ip route)</pre>
<h2>Firewall Rules:</h2>
<pre>$(sudo ip netns exec "$NAMESPACE" iptables -L -n -v 2>/dev/null || echo "No iptables rules")</pre>
</body>
</html>
EOF

# Start Python HTTP server in background
log "Starting HTTP server..."
sudo ip netns exec "$NAMESPACE" python3 -m http.server "$PORT" \
    --directory "$TEMP_DIR" \
    > "$LOG_DIR/${NAMESPACE}_${PORT}.log" 2>&1 &

SERVER_PID=$!
echo $SERVER_PID > "$PID_FILE"

# Wait a moment and check if server started
sleep 1

if ps -p $SERVER_PID > /dev/null; then
    log "âœ“ Server started successfully!"
    log "  PID: $SERVER_PID"
    log "  Namespace: $NAMESPACE"
    log "  Port: $PORT"
    log "  Log file: $LOG_DIR/${NAMESPACE}_${PORT}.log"
    log "  PID file: $PID_FILE"
    echo ""
    log "Test the server with:"
    log "  sudo ip netns exec $NAMESPACE curl http://localhost:$PORT"
    echo ""
    log "Stop the server with:"
    log "  kill $SERVER_PID"
    log "  or: pkill -f 'http.server $PORT'"
else
    log "ERROR: Server failed to start"
    rm -f "$PID_FILE"
    exit 1
fi
